#!/bin/bash
# Simplified shared audio approach using minimal dsnoop config

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }

echo ""
echo "════════════════════════════════════════════════════"
echo "  Simplified Shared Audio Configuration"
echo "════════════════════════════════════════════════════"
echo ""

if [ "$EUID" -ne 0 ]; then 
    log_error "Run as root"
    exit 1
fi

# Stop everything
log_info "Stopping services..."
systemctl stop evvos-picam-tcp 2>/dev/null || true
systemctl stop evvos-pico-voice 2>/dev/null || true
pkill -9 arecord 2>/dev/null || true
pkill -9 python3 2>/dev/null || true
sleep 2

# Clear IPC
ipcrm -M 2048 2>/dev/null || true
ipcrm -M 1024 2>/dev/null || true

log_success "Stopped everything"
echo ""

# Create MINIMAL dsnoop config
log_info "Creating minimal ALSA configuration..."

cat > /etc/asound.conf << 'EOF'
# Minimal dsnoop configuration for ReSpeaker
pcm.dsnooper {
    type dsnoop
    ipc_key 2048
    slave {
        pcm "hw:0,0"
        rate 48000
        channels 2
    }
}

pcm.!default {
    type asym
    playback.pcm "hw:0,0"
    capture.pcm "dsnooper"
}
EOF

log_success "Created minimal config"
echo ""

# Test hardware first
log_info "Test 1: Direct hardware"
if timeout 2 arecord -D hw:0,0 -f S16_LE -r 48000 -c 2 /tmp/test1.wav 2>&1; then
    SIZE=$(stat -c%s /tmp/test1.wav 2>/dev/null || echo "0")
    log_success "Hardware works: ${SIZE} bytes"
else
    log_error "Hardware test failed"
    exit 1
fi

# Test dsnooper
log_info "Test 2: dsnooper device"
echo "Attempting 2 second recording..."
if timeout 3 arecord -D dsnooper -f S16_LE -r 48000 -c 2 /tmp/test2.wav 2>&1; then
    SIZE=$(stat -c%s /tmp/test2.wav 2>/dev/null || echo "0")
    if [ "$SIZE" -gt 50000 ]; then
        log_success "✓ dsnooper works: ${SIZE} bytes"
        DSNOOPER_WORKS=true
    else
        log_error "dsnooper created tiny file: ${SIZE} bytes"
        DSNOOPER_WORKS=false
    fi
else
    log_error "dsnooper test failed or hung"
    DSNOOPER_WORKS=false
fi

echo ""

if [ "$DSNOOPER_WORKS" = true ]; then
    log_success "Shared audio configuration successful!"
    echo ""
    
    # Update camera service
    CAMERA_SCRIPT="/usr/local/bin/evvos-picam-tcp.py"
    if [ -f "$CAMERA_SCRIPT" ]; then
        cp "$CAMERA_SCRIPT" "${CAMERA_SCRIPT}.backup.$(date +%s)"
        sed -i 's/"-D", "plughw:seeed2micvoicec"/"-D", "dsnooper"/g' "$CAMERA_SCRIPT"
        sed -i 's/"-D", "hw:seeed2micvoicec"/"-D", "dsnooper"/g' "$CAMERA_SCRIPT"
        log_success "Camera script updated"
    fi
    
    # Start services
    systemctl start evvos-picam-tcp
    systemctl start evvos-pico-voice 2>/dev/null || true
    
    log_success "Services started"
    echo ""
    log_info "Test from your app now!"
    
else
    log_error "═══════════════════════════════════════════════════"
    log_error "  dsnoop DOES NOT WORK on this system"
    log_error "═══════════════════════════════════════════════════"
    echo ""
    echo "This can happen because:"
    echo "  • ALSA version too old (pre-1.0.9)"
    echo "  • ReSpeaker driver doesn't support dsnoop"
    echo "  • Kernel configuration doesn't allow shared access"
    echo ""
    log_info "SOLUTION: Use Plan B (pause voice service)"
    echo ""
    echo "Run this instead:"
    echo "  sudo bash plan_b_pause_voice_service.sh"
    echo ""
    echo "This will:"
    echo "  ✓ Guarantee audio recording works"
    echo "  ✓ Pause voice service only during recording"
    echo "  ✓ Resume voice after recording stops"
    echo "  ✓ 100% reliable (no ALSA complexity)"
    echo ""
    
    # Restore simple config
    cat > /etc/asound.conf << 'EOF'
# Simple direct hardware access (no sharing)
pcm.!default {
    type hw
    card seeed2micvoicec
}

ctl.!default {
    type hw
    card seeed2micvoicec
}
EOF
    
    # Restore camera script
    CAMERA_SCRIPT="/usr/local/bin/evvos-picam-tcp.py"
    if [ -f "$CAMERA_SCRIPT" ]; then
        sed -i 's/"-D", "dsnooper"/"-D", "plughw:seeed2micvoicec"/g' "$CAMERA_SCRIPT"
    fi
    
    log_info "Restored simple configuration"
    echo ""
    log_info "Ready for Plan B installation"
fi

echo ""
