#!/bin/bash
# Complete fix for shared audio - stops services, configures ALSA, restarts everything

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warning() { echo -e "${YELLOW}⚠${NC}  $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }

echo ""
echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  Complete Shared Audio Fix${NC}"
echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
echo ""

if [ "$EUID" -ne 0 ]; then 
    log_error "This script must be run as root"
    echo "Usage: sudo bash complete_shared_audio_fix.sh"
    exit 1
fi

# ============================================================================
# STEP 1: STOP ALL AUDIO SERVICES
# ============================================================================

log_info "Step 1: Stopping all services using audio..."
echo ""

# Stop camera service
if systemctl is-active --quiet evvos-picam-tcp; then
    systemctl stop evvos-picam-tcp
    log_success "Stopped camera service"
else
    log_info "Camera service not running"
fi

# Stop voice service
if systemctl is-active --quiet evvos-pico-voice; then
    systemctl stop evvos-pico-voice
    log_success "Stopped voice service"
else
    log_info "Voice service not running"
fi

# Kill any remaining audio processes
pkill -9 arecord 2>/dev/null || true
pkill -9 python3 2>/dev/null || true
sleep 2

log_success "All audio services stopped"
echo ""

# ============================================================================
# STEP 2: CREATE SHARED AUDIO CONFIGURATION
# ============================================================================

log_info "Step 2: Creating ALSA shared audio configuration..."
echo ""

# Backup existing config
if [ -f /etc/asound.conf ]; then
    cp /etc/asound.conf /etc/asound.conf.backup.$(date +%s)
    log_success "Backed up existing /etc/asound.conf"
fi

# Create new shared audio config
cat > /etc/asound.conf << 'EOF'
# ReSpeaker 2-Mics HAT V2.0 - Shared Audio Configuration
# CRITICAL: This allows multiple applications to access the microphone simultaneously

# Make dsnooper the default capture device
pcm.!default {
    type asym
    playback.pcm "dmixer"
    capture.pcm "dsnooper"
}

# Shared capture device (dsnoop) - allows multiple apps to record
pcm.dsnooper {
    type dsnoop
    ipc_key 2048
    ipc_perm 0666
    ipc_key_add_uid 0
    slave {
        pcm "hw:seeed2micvoicec"
        channels 2
        rate 48000
        period_size 1024
        buffer_size 8192
        format S16_LE
    }
    bindings {
        0 0
        1 1
    }
}

# Shared playback device (dmix)
pcm.dmixer {
    type dmix
    ipc_key 1024
    ipc_perm 0666
    ipc_key_add_uid 0
    slave {
        pcm "hw:seeed2micvoicec"
        channels 2
        rate 48000
        period_size 1024
        buffer_size 8192
        format S16_LE
    }
    bindings {
        0 0
        1 1
    }
}

# Direct hardware access (for debugging)
pcm.hw_seeed {
    type hw
    card seeed2micvoicec
}

# Control device
ctl.!default {
    type hw
    card seeed2micvoicec
}
EOF

log_success "Created /etc/asound.conf"
echo ""

# ============================================================================
# STEP 3: RELOAD ALSA
# ============================================================================

log_info "Step 3: Reloading ALSA..."
echo ""

# Unload and reload ALSA modules
if command -v alsactl &> /dev/null; then
    alsactl kill quit 2>/dev/null || true
    sleep 1
    alsactl restore 2>/dev/null || true
    log_success "ALSA reloaded"
else
    log_warning "alsactl not found, skipping ALSA reload"
fi

# Clear any shared memory segments from previous dsnoop instances
ipcrm -M 2048 2>/dev/null || true
ipcrm -M 1024 2>/dev/null || true
log_success "Cleared ALSA shared memory"

echo ""

# ============================================================================
# STEP 4: UPDATE CAMERA SERVICE SCRIPT
# ============================================================================

log_info "Step 4: Updating camera service to use dsnooper..."
echo ""

CAMERA_SCRIPT="/usr/local/bin/evvos-picam-tcp.py"

if [ ! -f "$CAMERA_SCRIPT" ]; then
    log_error "Camera script not found at $CAMERA_SCRIPT"
    exit 1
fi

# Backup
cp "$CAMERA_SCRIPT" "${CAMERA_SCRIPT}.backup.$(date +%s)"
log_success "Backed up camera script"

# Replace audio device
sed -i 's/"-D", "plughw:seeed2micvoicec"/"-D", "dsnooper"/g' "$CAMERA_SCRIPT"

# Verify change
if grep -q '"-D", "dsnooper"' "$CAMERA_SCRIPT"; then
    log_success "Camera script updated to use dsnooper"
else
    log_error "Failed to update camera script"
    exit 1
fi

echo ""

# ============================================================================
# STEP 5: TEST SHARED AUDIO (before starting services)
# ============================================================================

log_info "Step 5: Testing shared audio configuration..."
echo ""

# Test if dsnooper is available
log_info "Testing dsnooper device availability..."
if timeout 3 arecord -D dsnooper -f S16_LE -r 48000 -c 2 /tmp/test_dsnooper.wav 2>&1 | grep -q "Recording"; then
    FILE_SIZE=$(stat -c%s /tmp/test_dsnooper.wav 2>/dev/null || echo "0")
    if [ "$FILE_SIZE" -gt 10000 ]; then
        log_success "dsnooper test successful: ${FILE_SIZE} bytes"
    else
        log_warning "dsnooper test file too small: ${FILE_SIZE} bytes"
    fi
else
    log_error "dsnooper test failed"
    log_info "Checking ALSA configuration..."
    arecord -L | grep -A 2 dsnooper || log_warning "dsnooper not in ALSA device list"
fi

echo ""

# ============================================================================
# STEP 6: START SERVICES
# ============================================================================

log_info "Step 6: Starting services..."
echo ""

# Start camera service
systemctl start evvos-picam-tcp
sleep 2
if systemctl is-active --quiet evvos-picam-tcp; then
    log_success "Camera service started"
else
    log_error "Camera service failed to start"
    log_info "Check logs: sudo journalctl -u evvos-picam-tcp -n 50"
fi

# Start voice service
if systemctl is-enabled --quiet evvos-pico-voice 2>/dev/null; then
    systemctl start evvos-pico-voice
    sleep 2
    if systemctl is-active --quiet evvos-pico-voice; then
        log_success "Voice service started"
    else
        log_error "Voice service failed to start"
        log_info "Check logs: sudo journalctl -u evvos-pico-voice -n 50"
    fi
fi

echo ""

# ============================================================================
# STEP 7: TEST WITH BOTH SERVICES RUNNING
# ============================================================================

log_info "Step 7: Testing shared audio with services running..."
echo ""

sleep 3  # Give services time to initialize

log_info "Attempting 3-second test recording..."
if timeout 3 arecord -D dsnooper -f S16_LE -r 48000 -c 2 /tmp/test_with_services.wav 2>&1; then
    FILE_SIZE=$(stat -c%s /tmp/test_with_services.wav 2>/dev/null || echo "0")
    if [ "$FILE_SIZE" -gt 10000 ]; then
        log_success "Shared audio working! File size: ${FILE_SIZE} bytes"
        log_info "Play it: aplay /tmp/test_with_services.wav"
    else
        log_warning "Recording created but very small: ${FILE_SIZE} bytes"
    fi
else
    log_error "Test recording failed with services running"
    log_info "This means the shared audio configuration isn't working properly"
fi

echo ""

# ============================================================================
# STEP 8: DIAGNOSTICS
# ============================================================================

log_info "Step 8: System diagnostics..."
echo ""

echo "Services Status:"
echo "  Camera: $(systemctl is-active evvos-picam-tcp)"
echo "  Voice:  $(systemctl is-active evvos-pico-voice 2>/dev/null || echo 'not installed')"
echo ""

echo "ALSA Devices:"
arecord -L | grep -E "dsnooper|default|seeed" | head -10
echo ""

echo "Audio device locks:"
lsof /dev/snd/* 2>/dev/null | grep -v "COMMAND" || echo "  No locks detected"
echo ""

# ============================================================================
# SUMMARY
# ============================================================================

echo ""
echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  Configuration Complete${NC}"
echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
echo ""

log_info "What was done:"
echo "  ✓ Stopped all audio services"
echo "  ✓ Created /etc/asound.conf with dsnoop configuration"
echo "  ✓ Cleared ALSA shared memory"
echo "  ✓ Updated camera service to use dsnooper"
echo "  ✓ Restarted services"
echo ""

log_info "Next steps:"
echo "  1. Test from your app - start and stop a recording"
echo "  2. Check file sizes: ls -lh ~/recordings/"
echo "  3. Audio should now be > 0 MB"
echo ""

log_info "Manual test:"
echo "  arecord -D dsnooper -f S16_LE -r 48000 -c 2 -d 5 test.wav"
echo "  ls -lh test.wav  # Should show size > 0"
echo "  aplay test.wav"
echo ""

log_info "Troubleshooting:"
echo "  # View camera logs:"
echo "  sudo journalctl -u evvos-picam-tcp -f"
echo ""
echo "  # Check if dsnooper is blocked:"
echo "  lsof /dev/snd/*"
echo ""
echo "  # Test without services:"
echo "  sudo systemctl stop evvos-picam-tcp evvos-pico-voice"
echo "  arecord -D dsnooper -f S16_LE -r 48000 -c 2 -d 3 test.wav"
echo ""

if [ "$FILE_SIZE" -gt 10000 ]; then
    log_success "Shared audio is working! Test from your app now."
else
    log_warning "Shared audio may not be working properly."
    log_warning "Check the troubleshooting steps above."
fi

echo ""
