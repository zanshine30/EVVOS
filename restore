#!/bin/bash
# Properly fix voice service to use dsnooper - manual approach

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ“${NC} $1"; }
log_warning() { echo -e "${YELLOW}âš ${NC}  $1"; }
log_error() { echo -e "${RED}âœ—${NC} $1"; }

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Restore Voice Service & Configure for dsnooper"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if [ "$EUID" -ne 0 ]; then 
    log_error "Run as root"
    exit 1
fi

VOICE_SCRIPT="/usr/local/bin/evvos-pico-voice-service.py"

# Stop services
log_info "Stopping services..."
systemctl stop evvos-pico-voice 2>/dev/null || true
systemctl stop evvos-picam-tcp 2>/dev/null || true
sleep 2

# Restore from backup if it exists
log_info "Restoring voice service from backup..."

LATEST_BACKUP=$(ls -t ${VOICE_SCRIPT}.backup.* 2>/dev/null | head -1)

if [ -n "$LATEST_BACKUP" ]; then
    cp "$LATEST_BACKUP" "$VOICE_SCRIPT"
    log_success "Restored from: $LATEST_BACKUP"
else
    log_warning "No backup found - will try to fix in place"
fi

# Verify Python syntax
log_info "Checking Python syntax..."
if python3 -m py_compile "$VOICE_SCRIPT" 2>&1; then
    log_success "Python syntax is valid"
else
    log_error "Python file has syntax errors"
    python3 -m py_compile "$VOICE_SCRIPT" 2>&1 | tail -20
    
    # If still broken, we need to re-run the setup script
    log_error "Voice service is corrupted"
    echo ""
    log_info "Solution: Re-run voice setup script"
    echo "  sudo bash setup_pico_voice_recognition_respeaker.sh"
    echo ""
    exit 1
fi

echo ""

# Now configure PyAudio to use dsnooper through ALSA environment
log_info "Configuring ALSA environment for dsnooper..."

# Create systemd override directory
SERVICE_OVERRIDE_DIR="/etc/systemd/system/evvos-pico-voice.service.d"
mkdir -p "$SERVICE_OVERRIDE_DIR"

# Create override configuration
cat > "$SERVICE_OVERRIDE_DIR/shared-audio.conf" << 'EOF'
[Service]
# Configure ALSA to use dsnooper (shared audio device)
Environment="ALSA_PCM_CARD=dsnooper"
Environment="AUDIODEV=dsnooper"

# Also create .asoundrc for the service user
ExecStartPre=/bin/sh -c 'echo "pcm.!default { type asym; playback.pcm \\"dmixer\\"; capture.pcm \\"dsnooper\\"; }" > /root/.asoundrc'
EOF

log_success "Created systemd environment override"

# Reload systemd
systemctl daemon-reexec
systemctl daemon-reload
log_success "Reloaded systemd"

echo ""

# Test that dsnooper still works
log_info "Verifying dsnooper is available..."
if arecord -L | grep -q "dsnooper"; then
    log_success "dsnooper device available"
else
    log_error "dsnooper not found - run diagnose_dsnoop.sh first"
    exit 1
fi

echo ""

# Start voice service FIRST (it should grab dsnooper)
log_info "Starting voice service..."
systemctl start evvos-pico-voice

sleep 4

if systemctl is-active --quiet evvos-pico-voice; then
    log_success "Voice service started"
    
    # Check logs for errors
    if journalctl -u evvos-pico-voice -n 10 --no-pager | grep -i "error\|fail" | grep -v "ALSA lib"; then
        log_warning "Voice service has errors (check logs)"
    fi
else
    log_error "Voice service failed to start"
    echo ""
    log_info "Recent logs:"
    journalctl -u evvos-pico-voice -n 20 --no-pager
    exit 1
fi

echo ""

# Start camera service SECOND
log_info "Starting camera service..."
systemctl start evvos-picam-tcp

sleep 3

if systemctl is-active --quiet evvos-picam-tcp; then
    log_success "Camera service started"
else
    log_error "Camera service failed"
    exit 1
fi

echo ""

# Final test
log_info "Testing shared audio with both services running..."
echo ""

sleep 3

log_info "Attempting 5-second recording..."

# Use a different approach - record in background
arecord -D dsnooper -f S16_LE -r 48000 -c 2 /tmp/test_final_both.wav 2>/dev/null &
ARECORD_PID=$!

# Let it record for 4 seconds
sleep 4

# Check if arecord is still running
if ps -p $ARECORD_PID > /dev/null 2>&1; then
    # Kill it
    kill $ARECORD_PID 2>/dev/null
    wait $ARECORD_PID 2>/dev/null || true
    
    # Check file size
    SIZE=$(stat -c%s /tmp/test_final_both.wav 2>/dev/null || echo "0")
    
    if [ "$SIZE" -gt 300000 ]; then
        echo ""
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${GREEN}  âœ“âœ“âœ“ SUCCESS! SHARED AUDIO WORKING!${NC}"
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        log_success "Both services using shared audio: ${SIZE} bytes"
        log_info "Play test: aplay /tmp/test_final_both.wav"
        echo ""
        
        log_info "What's working:"
        echo "  âœ“ dsnooper device configured"
        echo "  âœ“ Voice service using shared audio"
        echo "  âœ“ Camera service using shared audio"
        echo "  âœ“ Both can record simultaneously"
        echo ""
        
        log_info "Test from your app:"
        echo "  1. Start recording"
        echo "  2. Try voice commands (should work!)"
        echo "  3. Stop recording"
        echo "  4. Check: ls -lh ~/recordings/"
        echo "  5. Audio should be > 0 MB"
        echo ""
        
        log_success "Hands-free navigation preserved! ðŸŽ‰"
        
    else
        echo ""
        echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}  Shared audio still not working: ${SIZE} bytes${NC}"
        echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        log_error "Recording failed or too small"
        echo ""
        log_info "Diagnostics:"
        echo ""
        echo "Processes using audio device:"
        lsof /dev/snd/* 2>/dev/null | head -10
        echo ""
        echo "Voice service logs:"
        journalctl -u evvos-pico-voice -n 15 --no-pager
        echo ""
        
        log_info "The issue is PyAudio isn't releasing hardware properly"
        echo ""
        log_warning "At this point, we need to modify the voice service Python code"
        log_warning "to explicitly use dsnooper device instead of auto-detection"
        echo ""
    fi
else
    log_error "arecord process died immediately"
    SIZE=$(stat -c%s /tmp/test_final_both.wav 2>/dev/null || echo "0")
    log_error "File size: ${SIZE} bytes"
fi

echo ""

# Show service status
log_info "Service status:"
systemctl status evvos-pico-voice --no-pager -l | head -8
echo ""
systemctl status evvos-picam-tcp --no-pager -l | head -8
echo ""
