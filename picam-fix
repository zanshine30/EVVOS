#!/bin/bash
# fix_picam_video.sh  (v2 — robust pattern matching)
#
# Fixes two issues in /usr/local/bin/evvos-picam-tcp.py:
#   1. Adds -framerate to ffmpeg commands so MP4 files have valid timestamps
#   2. Updates _notify_edge_function to pass video_size_mb + session_id
#
# Run on the Pi:
#   curl -fsSL https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/fix_picam_video.sh | sudo bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${CYAN}══════════════════════════════════════════════════${NC}"
echo -e "${CYAN}  EVVOS Pi Camera — Video + Metadata Fix (v2)     ${NC}"
echo -e "${CYAN}══════════════════════════════════════════════════${NC}"
echo ""

if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}ERROR: Run as root: curl ... | sudo bash${NC}"
    exit 1
fi

SCRIPT_PATH="/usr/local/bin/evvos-picam-tcp.py"

if [ ! -f "$SCRIPT_PATH" ]; then
    echo -e "${RED}ERROR: $SCRIPT_PATH not found — run setup_picam.sh first.${NC}"
    exit 1
fi

BACKUP="${SCRIPT_PATH}.bak.$(date +%Y%m%d_%H%M%S)"
cp "$SCRIPT_PATH" "$BACKUP"
echo -e "${GREEN}✓ Backup: $BACKUP${NC}"

# Print the actual ffmpeg lines so we can see what's there
echo ""
echo -e "${YELLOW}Current ffmpeg lines in script:${NC}"
grep -n "ffmpeg\|framerate\|bitrate\|current_video_path\|current_audio_path" "$SCRIPT_PATH" || true
echo ""

PATCH_FILE="/tmp/fix_picam_video.py"

cat > "$PATCH_FILE" << 'PYTHON_EOF'
import sys, re

SCRIPT_PATH = "/usr/local/bin/evvos-picam-tcp.py"

with open(SCRIPT_PATH) as fh:
    source = fh.read()

errors = []

# ─────────────────────────────────────────────────────────────────────────────
# FIX 1 & 2: Add -framerate before every "-i", str(current_video_path) that
# doesn't already have it.
#
# Uses regex so it handles any whitespace / indentation variation.
# Matches the pattern:   "ffmpeg", "-y",
#                            ...optional lines...
#                            "-i", str(current_video_path),
# and inserts:               "-framerate", str(CAMERA_FPS),
# immediately before the -i line.
# ─────────────────────────────────────────────────────────────────────────────

if '-framerate' in source:
    print("⚠ -framerate already present in script — skipping Fix 1 & 2")
else:
    # Find every occurrence of '"-i", str(current_video_path)' and insert
    # '-framerate', str(CAMERA_FPS), on the line before it, with matching indent.
    pattern = re.compile(
        r'( *)(\"|\')(-i)(\"|\'),\s*(str\(current_video_path\))',
    )

    def insert_framerate(m):
        indent = m.group(1)
        quote  = m.group(2)  # " or '
        return (
            f'{indent}{quote}-framerate{quote}, str(CAMERA_FPS),   '
            f'# synthesise PTS — raw H.264 has no timestamps\n'
            f'{m.group(0)}'
        )

    new_source, count = pattern.subn(insert_framerate, source)

    if count == 0:
        errors.append(
            "Could not find any '\"-i\", str(current_video_path)' patterns.\n"
            "  Check the grep output above to see the actual ffmpeg lines."
        )
    else:
        source = new_source
        print(f"✓ Fix 1 & 2: -framerate inserted before {count} ffmpeg -i line(s)")

# ─────────────────────────────────────────────────────────────────────────────
# FIX 3: _notify_edge_function signature — add video_size_mb + session_id
# Uses regex to match regardless of exact spacing.
# ─────────────────────────────────────────────────────────────────────────────

sig_pattern = re.compile(
    r'def _notify_edge_function\(incident_id,\s*video_url,\s*storage_path,\s*auth_token=None\):'
)

if 'video_size_mb=None' in source:
    print("⚠ Fix 3 (notify signature) already applied — skipping")
elif not sig_pattern.search(source):
    print("⚠ Fix 3: _notify_edge_function not found — run install_picam_upload.sh first")
else:
    source = sig_pattern.sub(
        'def _notify_edge_function(incident_id, video_url, storage_path, '
        'auth_token=None, video_size_mb=None, session_id=None):',
        source,
        count=1,
    )
    print("✓ Fix 3: _notify_edge_function signature updated")

# ─────────────────────────────────────────────────────────────────────────────
# FIX 4: _notify_edge_function body — replace the json= dict to include
# video_size_mb and session_id.
# ─────────────────────────────────────────────────────────────────────────────

json_pattern = re.compile(
    r'json=\{"incident_id":\s*incident_id,\s*"video_url":\s*video_url,\s*"storage_path":\s*storage_path\},'
)

if '"video_size_mb"' in source and '"session_id"' in source:
    print("⚠ Fix 4 (notify json body) already applied — skipping")
elif not json_pattern.search(source):
    print("⚠ Fix 4: notify json pattern not found — run install_picam_upload.sh first")
else:
    source = json_pattern.sub(
        'json={\n'
        '                "incident_id":   incident_id,\n'
        '                "video_url":     video_url,\n'
        '                "storage_path":  storage_path,\n'
        '                "video_size_mb": video_size_mb,\n'
        '                "session_id":    session_id,\n'
        '            },',
        source,
        count=1,
    )
    print("✓ Fix 4: video_size_mb + session_id added to edge function payload")

# ─────────────────────────────────────────────────────────────────────────────
# FIX 5: _do_upload — pass video_size_mb + session_id to _notify_edge_function
# ─────────────────────────────────────────────────────────────────────────────

call_pattern = re.compile(
    r'_notify_edge_function\(incident_id,\s*video_url,\s*storage_path,\s*auth_token\)'
)

if 'video_size_mb=file_size_mb' in source:
    print("⚠ Fix 5 (_do_upload notify call) already applied — skipping")
elif not call_pattern.search(source):
    print("⚠ Fix 5: _notify_edge_function call not found — run install_picam_upload.sh first")
else:
    source = call_pattern.sub(
        '_notify_edge_function(incident_id, video_url, storage_path, auth_token, '
        'video_size_mb=file_size_mb, session_id=session_id)',
        source,
        count=1,
    )
    print("✓ Fix 5: _do_upload passes size + session_id to edge function")

# ─────────────────────────────────────────────────────────────────────────────
# Write result
# ─────────────────────────────────────────────────────────────────────────────

if errors:
    print("\nERRORS:")
    for e in errors:
        print(f"  • {e}")
    sys.exit(1)

with open(SCRIPT_PATH, "w") as fh:
    fh.write(source)
print(f"\n✓ Patched script saved to {SCRIPT_PATH}")
PYTHON_EOF

echo "Running patch..."
echo ""
python3 "$PATCH_FILE"
EXIT_CODE=$?

rm -f "$PATCH_FILE"

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo -e "${RED}✗ Patch failed — restoring backup${NC}"
    cp "$BACKUP" "$SCRIPT_PATH"
    exit $EXIT_CODE
fi

echo ""
echo "↻ Restarting evvos-picam-tcp..."
systemctl restart evvos-picam-tcp.service
echo -e "${GREEN}✓ Service restarted${NC}"

echo ""
echo -e "${GREEN}══════════════════════════════════════════════════${NC}"
echo -e "${GREEN}✓ Fix complete!${NC}"
echo -e "${GREEN}══════════════════════════════════════════════════${NC}"
echo ""
echo "Verify: sudo journalctl -u evvos-picam-tcp -f"
