#!/bin/bash
# Complete Revert Script - Restore to stable state
# Video works, Voice works, Audio recording 0.00 MB (but at least nothing is broken)

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warning() { echo -e "${YELLOW}⚠${NC}  $1"; }

echo ""
echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  Complete System Revert${NC}"
echo -e "${GREEN}  Restoring to stable working state${NC}"
echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
echo ""

if [ "$EUID" -ne 0 ]; then 
    log_warning "Run as root: sudo bash revert_everything.sh"
    exit 1
fi

# ============================================================================
# STEP 1: STOP ALL SERVICES
# ============================================================================

log_info "Step 1: Stopping all services..."
echo ""

systemctl stop evvos-picam-tcp 2>/dev/null || true
systemctl stop evvos-pico-voice 2>/dev/null || true
pkill -9 arecord 2>/dev/null || true
pkill -9 python3 2>/dev/null || true

sleep 2
log_success "All services stopped"
echo ""

# ============================================================================
# STEP 2: RESTORE VOICE SERVICE FROM BACKUP
# ============================================================================

log_info "Step 2: Restoring voice service from backup..."
echo ""

VOICE_SCRIPT="/usr/local/bin/evvos-pico-voice-service.py"

if [ -f "$VOICE_SCRIPT" ]; then
    # Find the oldest backup (original, before modifications)
    OLDEST_BACKUP=$(ls -t ${VOICE_SCRIPT}.backup.* 2>/dev/null | tail -1)
    
    if [ -n "$OLDEST_BACKUP" ]; then
        cp "$OLDEST_BACKUP" "$VOICE_SCRIPT"
        log_success "Restored voice service from: $OLDEST_BACKUP"
        
        # Verify syntax
        if python3 -m py_compile "$VOICE_SCRIPT" 2>&1; then
            log_success "Voice service syntax valid"
        else
            log_warning "Voice service still has issues - may need full reinstall"
        fi
    else
        log_warning "No voice service backup found"
        log_info "Voice service may need reinstall if broken"
    fi
else
    log_warning "Voice service script not found"
fi

echo ""

# ============================================================================
# STEP 3: RESTORE CAMERA SERVICE FROM BACKUP
# ============================================================================

log_info "Step 3: Restoring camera service from backup..."
echo ""

CAMERA_SCRIPT="/usr/local/bin/evvos-picam-tcp.py"

if [ -f "$CAMERA_SCRIPT" ]; then
    # Find oldest backup
    OLDEST_BACKUP=$(ls -t ${CAMERA_SCRIPT}.backup.* 2>/dev/null | tail -1)
    
    if [ -n "$OLDEST_BACKUP" ]; then
        cp "$OLDEST_BACKUP" "$CAMERA_SCRIPT"
        log_success "Restored camera service from: $OLDEST_BACKUP"
    else
        log_warning "No camera service backup found"
    fi
    
    # Make sure it uses direct hardware access (not dsnooper)
    sed -i 's/"-D", "dsnooper"/"-D", "plughw:seeed2micvoicec"/g' "$CAMERA_SCRIPT"
    log_success "Camera service using direct hardware access"
else
    log_warning "Camera service script not found"
fi

echo ""

# ============================================================================
# STEP 4: REMOVE SHARED AUDIO CONFIGURATION
# ============================================================================

log_info "Step 4: Removing shared audio configuration..."
echo ""

# Remove or disable /etc/asound.conf
if [ -f /etc/asound.conf ]; then
    mv /etc/asound.conf /etc/asound.conf.disabled.$(date +%s)
    log_success "Disabled /etc/asound.conf"
fi

# Remove root .asoundrc
if [ -f /root/.asoundrc ]; then
    mv /root/.asoundrc /root/.asoundrc.disabled.$(date +%s)
    log_success "Disabled /root/.asoundrc"
fi

# Remove systemd overrides
if [ -d /etc/systemd/system/evvos-pico-voice.service.d ]; then
    mv /etc/systemd/system/evvos-pico-voice.service.d /etc/systemd/system/evvos-pico-voice.service.d.disabled.$(date +%s)
    log_success "Disabled voice service overrides"
fi

systemctl daemon-reload
log_success "Reloaded systemd"

echo ""

# ============================================================================
# STEP 5: CLEAR ALL TEST FILES
# ============================================================================

log_info "Step 5: Cleaning up test files..."
echo ""

# Remove all test .wav files
rm -f /tmp/test*.wav 2>/dev/null || true
rm -f /tmp/*.wav 2>/dev/null || true

# Count removed files
TEST_COUNT=$(ls /tmp/*.wav 2>/dev/null | wc -l)
log_success "Cleaned up test files from /tmp"

echo ""

# ============================================================================
# STEP 6: CLEAR ALSA SHARED MEMORY
# ============================================================================

log_info "Step 6: Clearing ALSA shared memory..."
echo ""

ipcrm -M 2048 2>/dev/null || true
ipcrm -M 1024 2>/dev/null || true
ipcrm -M 5678 2>/dev/null || true
ipcrm -M 5679 2>/dev/null || true

log_success "Cleared ALSA IPC segments"

echo ""

# ============================================================================
# STEP 7: START SERVICES
# ============================================================================

log_info "Step 7: Starting services..."
echo ""

# Start voice service
if systemctl is-enabled --quiet evvos-pico-voice 2>/dev/null; then
    systemctl start evvos-pico-voice
    sleep 3
    
    if systemctl is-active --quiet evvos-pico-voice; then
        log_success "Voice service started"
    else
        log_warning "Voice service failed to start"
        log_info "Check logs: sudo journalctl -u evvos-pico-voice -n 50"
        log_info "May need to run: sudo bash setup_pico_voice_recognition_respeaker.sh"
    fi
else
    log_info "Voice service not installed (skipping)"
fi

# Start camera service
if systemctl is-enabled --quiet evvos-picam-tcp 2>/dev/null; then
    systemctl start evvos-picam-tcp
    sleep 2
    
    if systemctl is-active --quiet evvos-picam-tcp; then
        log_success "Camera service started"
    else
        log_warning "Camera service failed to start"
        log_info "Check logs: sudo journalctl -u evvos-picam-tcp -n 50"
        log_info "May need to run: sudo bash setup_picam.sh"
    fi
else
    log_info "Camera service not installed (skipping)"
fi

echo ""

# ============================================================================
# STEP 8: VERIFY SYSTEM STATE
# ============================================================================

log_info "Step 8: Verifying system state..."
echo ""

echo "Service Status:"
echo "  Voice:  $(systemctl is-active evvos-pico-voice 2>/dev/null || echo 'not installed')"
echo "  Camera: $(systemctl is-active evvos-picam-tcp 2>/dev/null || echo 'not installed')"
echo ""

echo "Configuration Files:"
echo "  /etc/asound.conf: $([ -f /etc/asound.conf ] && echo 'exists' || echo 'removed ✓')"
echo "  /root/.asoundrc: $([ -f /root/.asoundrc ] && echo 'exists' || echo 'removed ✓')"
echo ""

echo "Audio Device:"
if arecord -l | grep -q seeed; then
    log_success "ReSpeaker detected"
else
    log_warning "ReSpeaker not detected"
fi
echo ""

# ============================================================================
# STEP 9: TEST BASIC FUNCTIONALITY
# ============================================================================

log_info "Step 9: Testing basic functionality..."
echo ""

# Test direct hardware access
log_info "Testing direct hardware audio recording..."
timeout 3 arecord -D plughw:seeed2micvoicec -f S16_LE -r 48000 -c 2 /tmp/final_test.wav 2>/dev/null &
sleep 2.5
pkill arecord 2>/dev/null || true
wait 2>/dev/null || true

SIZE=$(stat -c%s /tmp/final_test.wav 2>/dev/null || echo "0")
if [ "$SIZE" -gt 100000 ]; then
    log_success "Direct hardware access works: ${SIZE} bytes"
else
    log_warning "Hardware access issue: ${SIZE} bytes"
fi

rm -f /tmp/final_test.wav 2>/dev/null || true

echo ""

# ============================================================================
# SUMMARY
# ============================================================================

echo ""
echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  Revert Complete - System Restored${NC}"
echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
echo ""

log_info "Current State:"
echo "  ✓ Shared audio configuration removed"
echo "  ✓ Services restored from backups"
echo "  ✓ Test files cleaned up"
echo "  ✓ Direct hardware access working"
echo ""

log_info "What's Working:"
echo "  ✅ Video recording (camera)"
echo "  ✅ Voice commands (when not recording)"
echo "  ⚠️  Audio recording (0.00 MB - known issue)"
echo ""

log_info "Known Issue:"
echo "  • Audio shows 0.00 MB because voice service locks microphone"
echo "  • Video recording works perfectly"
echo "  • Voice commands work when not recording"
echo ""

log_info "Next Steps - Choose One:"
echo ""
echo "  Option A: Live with 0.00 MB audio (video still works)"
echo "    → No changes needed"
echo "    → Everything else functional"
echo ""
echo "  Option B: Get audio working (lose voice during recording)"
echo "    → Run: sudo bash plan_b_pause_voice_service.sh"
echo "    → Audio will work (pause voice service during recording)"
echo "    → Voice commands work before/after recording"
echo ""
echo "  Option C: Full hands-free (requires hardware)"
echo "    → Add USB microphone for voice commands"
echo "    → ReSpeaker for incident recording"
echo "    → No conflicts, both work always"
echo ""

log_info "Monitor Services:"
echo "  sudo journalctl -u evvos-picam-tcp -f"
echo "  sudo journalctl -u evvos-pico-voice -f"
echo ""

log_success "System reverted to stable state"
echo ""
