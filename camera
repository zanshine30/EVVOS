#!/bin/bash
# fix_picam_video.sh
#
# Fixes two issues in /usr/local/bin/evvos-picam-tcp.py:
#   1. Adds -framerate to ffmpeg commands so MP4 files have valid timestamps
#      (without this, players reject the file as corrupt)
#   2. Updates _notify_edge_function to pass video_size_mb + session_id
#      so the notify-video-uploaded edge function can write those columns
#
# Run on the Pi:
#   curl -fsSL https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/fix_picam_video.sh | sudo bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${CYAN}══════════════════════════════════════════════════${NC}"
echo -e "${CYAN}  EVVOS Pi Camera — Video + Metadata Fix          ${NC}"
echo -e "${CYAN}══════════════════════════════════════════════════${NC}"
echo ""

if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}ERROR: Run as root: curl ... | sudo bash${NC}"
    exit 1
fi

SCRIPT_PATH="/usr/local/bin/evvos-picam-tcp.py"

if [ ! -f "$SCRIPT_PATH" ]; then
    echo -e "${RED}ERROR: $SCRIPT_PATH not found — run setup_picam.sh first.${NC}"
    exit 1
fi

# Backup
BACKUP="${SCRIPT_PATH}.bak.$(date +%Y%m%d_%H%M%S)"
cp "$SCRIPT_PATH" "$BACKUP"
echo -e "${GREEN}✓ Backup: $BACKUP${NC}"

PATCH_FILE="/tmp/fix_picam_video.py"

cat > "$PATCH_FILE" << 'PYTHON_EOF'
import sys, re

SCRIPT_PATH = "/usr/local/bin/evvos-picam-tcp.py"

with open(SCRIPT_PATH) as fh:
    source = fh.read()

errors = []

# ─────────────────────────────────────────────────────────────────────────────
# FIX 1: ffmpeg video+audio command — add -framerate before -i video.h264
#
# Raw H.264 from picamera2 has no PTS/DTS timestamps. Adding -framerate
# tells ffmpeg the stream's frame rate so it can synthesise timestamps
# during the rewrap. Without this the MP4 is invalid and players reject it.
# ─────────────────────────────────────────────────────────────────────────────

OLD_FFMPEG_AV = '''\
                ffmpeg_cmd = [
                    "ffmpeg", "-y",
                    "-i", str(current_video_path),   # H.264 raw bitstream
                    "-i", str(current_audio_path),   # WAV PCM audio
                    "-c:v", "copy",                  # copy video stream as-is
                    "-c:a", "aac",                   # encode audio to AAC
                    "-movflags", "+faststart",        # moov atom at front (better streaming)
                    "-loglevel", "error",
                    str(mp4_path)
                ]'''

NEW_FFMPEG_AV = '''\
                ffmpeg_cmd = [
                    "ffmpeg", "-y",
                    "-framerate", str(CAMERA_FPS),   # synthesise PTS for raw H.264 (no timestamps in bitstream)
                    "-i", str(current_video_path),   # H.264 raw bitstream
                    "-i", str(current_audio_path),   # WAV PCM audio
                    "-c:v", "copy",                  # copy video stream as-is
                    "-c:a", "aac",                   # encode audio to AAC
                    "-movflags", "+faststart",        # moov atom at front (better streaming)
                    "-loglevel", "error",
                    str(mp4_path)
                ]'''

if '-framerate' in source and 'current_audio_path),   # WAV' in source:
    print("⚠ Fix 1 (AV ffmpeg) already applied — skipping")
elif OLD_FFMPEG_AV not in source:
    errors.append("Fix 1: Could not find AV ffmpeg command to patch")
else:
    source = source.replace(OLD_FFMPEG_AV, NEW_FFMPEG_AV, 1)
    print("✓ Fix 1 applied: -framerate added to video+audio ffmpeg command")

# ─────────────────────────────────────────────────────────────────────────────
# FIX 2: ffmpeg video-only command — same fix for the audio-missing fallback
# ─────────────────────────────────────────────────────────────────────────────

OLD_FFMPEG_V = '''\
                ffmpeg_cmd = [
                    "ffmpeg", "-y",
                    "-i", str(current_video_path),
                    "-c:v", "copy",
                    "-an",                           # no audio track
                    "-movflags", "+faststart",
                    "-loglevel", "error",
                    str(mp4_path)
                ]'''

NEW_FFMPEG_V = '''\
                ffmpeg_cmd = [
                    "ffmpeg", "-y",
                    "-framerate", str(CAMERA_FPS),   # synthesise PTS for raw H.264
                    "-i", str(current_video_path),
                    "-c:v", "copy",
                    "-an",                           # no audio track
                    "-movflags", "+faststart",
                    "-loglevel", "error",
                    str(mp4_path)
                ]'''

if OLD_FFMPEG_V not in source:
    print("⚠ Fix 2 (video-only ffmpeg): pattern not found — may already be patched or modified")
else:
    source = source.replace(OLD_FFMPEG_V, NEW_FFMPEG_V, 1)
    print("✓ Fix 2 applied: -framerate added to video-only ffmpeg command")

# ─────────────────────────────────────────────────────────────────────────────
# FIX 3: _notify_edge_function — pass video_size_mb and session_id
#
# The notify-video-uploaded edge function uses these to update the
# incidents table columns that are currently left NULL.
# ─────────────────────────────────────────────────────────────────────────────

OLD_NOTIFY = '''\
            json={"incident_id": incident_id, "video_url": video_url, "storage_path": storage_path},'''

NEW_NOTIFY = '''\
            json={
                "incident_id":    incident_id,
                "video_url":      video_url,
                "storage_path":   storage_path,
                "video_size_mb":  video_size_mb,
                "session_id":     session_id,
            },'''

if 'video_size_mb' in source and '"incident_id":    incident_id' in source:
    print("⚠ Fix 3 (_notify_edge_function) already applied — skipping")
elif OLD_NOTIFY not in source:
    print("⚠ Fix 3: _notify_edge_function pattern not found — may not be patched yet")
    print("   Run install_picam_upload.sh first, then re-run this script.")
else:
    source = source.replace(OLD_NOTIFY, NEW_NOTIFY, 1)
    print("✓ Fix 3 applied: video_size_mb + session_id added to edge function call")

# ─────────────────────────────────────────────────────────────────────────────
# FIX 4: _notify_edge_function signature — add video_size_mb + session_id params
# ─────────────────────────────────────────────────────────────────────────────

OLD_NOTIFY_DEF = 'def _notify_edge_function(incident_id, video_url, storage_path, auth_token=None):'
NEW_NOTIFY_DEF = 'def _notify_edge_function(incident_id, video_url, storage_path, auth_token=None, video_size_mb=None, session_id=None):'

if 'video_size_mb=None, session_id=None' in source:
    print("⚠ Fix 4 (notify signature) already applied — skipping")
elif OLD_NOTIFY_DEF not in source:
    print("⚠ Fix 4: _notify_edge_function def not found — may not be patched yet")
else:
    source = source.replace(OLD_NOTIFY_DEF, NEW_NOTIFY_DEF, 1)
    print("✓ Fix 4 applied: _notify_edge_function signature updated")

# ─────────────────────────────────────────────────────────────────────────────
# FIX 5: _do_upload — pass video_size_mb + session_id to _notify_edge_function
# ─────────────────────────────────────────────────────────────────────────────

OLD_DO_UPLOAD_NOTIFY = '        _notify_edge_function(incident_id, video_url, storage_path, auth_token)'
NEW_DO_UPLOAD_NOTIFY = '        _notify_edge_function(incident_id, video_url, storage_path, auth_token, video_size_mb=file_size_mb, session_id=session_id)'

if 'video_size_mb=file_size_mb' in source:
    print("⚠ Fix 5 (_do_upload notify call) already applied — skipping")
elif OLD_DO_UPLOAD_NOTIFY not in source:
    print("⚠ Fix 5: _do_upload notify call not found — may not be patched yet")
else:
    source = source.replace(OLD_DO_UPLOAD_NOTIFY, NEW_DO_UPLOAD_NOTIFY, 1)
    print("✓ Fix 5 applied: _do_upload passes size + session_id to edge function")

if errors:
    print("\nERRORS:")
    for e in errors:
        print(f"  • {e}")
    sys.exit(1)

with open(SCRIPT_PATH, "w") as fh:
    fh.write(source)
print(f"\n✓ Patched script saved to {SCRIPT_PATH}")
PYTHON_EOF

echo "Running patch..."
echo ""
python3 "$PATCH_FILE"
EXIT_CODE=$?

rm -f "$PATCH_FILE"

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo -e "${RED}✗ Patch failed — restoring backup${NC}"
    cp "$BACKUP" "$SCRIPT_PATH"
    exit $EXIT_CODE
fi

echo ""
echo "↻ Restarting evvos-picam-tcp..."
systemctl restart evvos-picam-tcp.service
echo -e "${GREEN}✓ Service restarted${NC}"

echo ""
echo -e "${GREEN}══════════════════════════════════════════════════${NC}"
echo -e "${GREEN}✓ Fix complete!${NC}"
echo -e "${GREEN}══════════════════════════════════════════════════${NC}"
echo ""
echo "Verify with:  sudo journalctl -u evvos-picam-tcp -f"
echo ""
echo -e "${YELLOW}NOTE: Re-run install_picam_upload.sh first if Fix 3/4/5${NC}"
echo -e "${YELLOW}      report 'pattern not found' (means queue patch not applied yet).${NC}"
