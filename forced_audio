#!/bin/bash
# Force voice service to use dsnooper instead of direct hardware access

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warning() { echo -e "${YELLOW}⚠${NC}  $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }

echo ""
echo "════════════════════════════════════════════════════"
echo "  Force Voice Service to Use Shared Audio"
echo "════════════════════════════════════════════════════"
echo ""

if [ "$EUID" -ne 0 ]; then 
    log_error "Run as root"
    exit 1
fi

# Stop services
log_info "Stopping services..."
systemctl stop evvos-picam-tcp 2>/dev/null || true
systemctl stop evvos-pico-voice 2>/dev/null || true
sleep 2
log_success "Services stopped"
echo ""

# Find the voice service Python script
VOICE_SCRIPT="/usr/local/bin/evvos-pico-voice-service.py"

if [ ! -f "$VOICE_SCRIPT" ]; then
    log_error "Voice service script not found at $VOICE_SCRIPT"
    log_info "Looking in common locations..."
    find /usr/local/bin /opt -name "*pico*voice*.py" 2>/dev/null | head -5
    exit 1
fi

log_success "Found voice script: $VOICE_SCRIPT"
echo ""

# Backup
cp "$VOICE_SCRIPT" "${VOICE_SCRIPT}.backup.$(date +%s)"
log_success "Backed up voice script"

# Create a Python script to modify the voice service
cat > /tmp/update_voice_script.py << 'PYTHON_UPDATE'
import sys
import re

script_path = sys.argv[1]

with open(script_path, 'r') as f:
    content = f.read()

# Find the section where PyAudio opens the stream
# Look for patterns like:
#   self.audio_stream = self.pa.open(
#       input_device_index=dev_idx,
#       ...

# Pattern 1: Look for the PyAudio open call
pattern1 = r"(self\.audio_stream = self\.pa\.open\(\s*\n\s*input_device_index=dev_idx,)"

# Add a configuration to use ALSA device name instead of device index
replacement1 = r"""# Force use of dsnooper (shared audio device)
            import os
            os.environ['ALSA_CARD'] = 'dsnooper'
            
            \1"""

if re.search(pattern1, content):
    content = re.sub(pattern1, replacement1, content, count=1)
    print("✓ Added ALSA_CARD environment variable", file=sys.stderr)
else:
    print("⚠ Could not find PyAudio open pattern", file=sys.stderr)

# Pattern 2: Alternative approach - modify device selection
# Find where device name is detected
pattern2 = r"(if 'seeed' in info\['name'\]\.lower\(\):)"
replacement2 = r"""# Prefer dsnooper for shared access
            if 'dsnooper' in info['name'].lower():
                dev_idx = i
                dev_name = info['name']
                logger.info(f"Using shared audio device: {dev_name} (index {i})")
                break
            elif \1"""

if re.search(pattern2, content):
    content = re.sub(pattern2, replacement2, content, count=1)
    print("✓ Added dsnooper preference in device selection", file=sys.stderr)

# Write back
with open(script_path, 'w') as f:
    f.write(content)

print("✓ Voice script updated", file=sys.stderr)
PYTHON_UPDATE

# Run the update
python3 /tmp/update_voice_script.py "$VOICE_SCRIPT"

if [ $? -eq 0 ]; then
    log_success "Voice script modified to prefer dsnooper"
else
    log_warning "Script modification had issues"
fi

echo ""

# Also create a systemd override to set ALSA environment
SERVICE_OVERRIDE_DIR="/etc/systemd/system/evvos-pico-voice.service.d"
mkdir -p "$SERVICE_OVERRIDE_DIR"

cat > "$SERVICE_OVERRIDE_DIR/alsa-override.conf" << 'EOF'
[Service]
# Force PyAudio to use dsnooper (shared audio device)
Environment="ALSA_CARD=dsnooper"
Environment="AUDIODEV=dsnooper"
EOF

log_success "Created systemd environment override"
systemctl daemon-reload
log_success "Reloaded systemd"

echo ""

# Start services in order
log_info "Starting services..."
echo ""

# Start voice service FIRST (so it grabs dsnooper, not hardware)
if systemctl is-enabled --quiet evvos-pico-voice 2>/dev/null; then
    systemctl start evvos-pico-voice
    sleep 3
    
    if systemctl is-active --quiet evvos-pico-voice; then
        log_success "Voice service started"
    else
        log_error "Voice service failed"
        journalctl -u evvos-pico-voice -n 20 --no-pager
        exit 1
    fi
fi

# Then start camera service
systemctl start evvos-picam-tcp
sleep 2

if systemctl is-active --quiet evvos-picam-tcp; then
    log_success "Camera service started"
else
    log_error "Camera service failed"
    exit 1
fi

echo ""

# Test
log_info "Testing shared audio with both services..."
echo ""

sleep 3

timeout 4 arecord -D dsnooper -f S16_LE -r 48000 -c 2 /tmp/test_final_shared.wav 2>/dev/null &
sleep 3.5
pkill arecord 2>/dev/null || true
wait 2>/dev/null || true

SIZE=$(stat -c%s /tmp/test_final_shared.wav 2>/dev/null || echo "0")

echo ""
if [ "$SIZE" -gt 200000 ]; then
    echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  ✓✓✓ SUCCESS! Shared Audio Working!${NC}"
    echo -e "${GREEN}════════════════════════════════════════════════════${NC}"
    echo ""
    log_success "Both services using shared audio: ${SIZE} bytes"
    echo ""
    log_info "Test from your app now!"
else
    echo -e "${YELLOW}════════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}  Still Not Working: ${SIZE} bytes${NC}"
    echo -e "${YELLOW}════════════════════════════════════════════════════${NC}"
    echo ""
    log_error "Shared audio still blocked"
    echo ""
    log_info "At this point, PyAudio is fundamentally incompatible with dsnoop"
    log_info "The ONLY reliable solution is Plan B:"
    echo ""
    echo "  sudo bash plan_b_pause_voice_service.sh"
    echo ""
    log_info "Plan B will:"
    echo "  ✓ Pause voice service when recording starts"
    echo "  ✓ Resume voice service when recording stops"
    echo "  ✓ 100% guarantee audio recording works"
    echo "  ✓ Better audio quality (direct hardware)"
    echo ""
fi

echo ""
