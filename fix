#!/bin/bash
# Modify voice service to explicitly use dsnooper device name

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }

echo ""
echo "════════════════════════════════════════════════════"
echo "  Modify Voice Service to Use dsnooper Explicitly"
echo "════════════════════════════════════════════════════"
echo ""

if [ "$EUID" -ne 0 ]; then 
    log_error "Run as root"
    exit 1
fi

VOICE_SCRIPT="/usr/local/bin/evvos-pico-voice-service.py"

# Stop service
systemctl stop evvos-pico-voice 2>/dev/null || true

# Backup
cp "$VOICE_SCRIPT" "${VOICE_SCRIPT}.backup.before_dsnooper.$(date +%s)"
log_success "Backed up voice script"

# Create Python modifier
cat > /tmp/modify_voice_for_dsnooper.py << 'PYTHON_CODE'
#!/usr/bin/env python3
import sys
import re

script_path = sys.argv[1]

with open(script_path, 'r') as f:
    lines = f.readlines()

# Find the line where PyAudio opens the stream
# We need to add input_device_index parameter or modify device selection

modified = False
new_lines = []
in_audio_open = False
indent = ""

for i, line in enumerate(lines):
    # Look for the PyAudio open() call
    if 'self.audio_stream = self.pa.open(' in line:
        in_audio_open = True
        indent = line[:len(line) - len(line.lstrip())]
        new_lines.append(line)
        
        # Add code to force dsnooper device
        new_lines.append(f'{indent}    # Force use of dsnooper (shared audio device)\n')
        new_lines.append(f'{indent}    import os\n')
        new_lines.append(f'{indent}    os.environ["ALSA_PCM_CARD"] = "dsnooper"\n')
        new_lines.append(f'{indent}    \n')
        modified = True
        continue
    
    new_lines.append(line)

if modified:
    with open(script_path, 'w') as f:
        f.writelines(new_lines)
    print("✓ Modified voice service to use dsnooper", file=sys.stderr)
else:
    print("✗ Could not find PyAudio open() call", file=sys.stderr)
    sys.exit(1)
PYTHON_CODE

chmod +x /tmp/modify_voice_for_dsnooper.py

# Run modifier
python3 /tmp/modify_voice_for_dsnooper.py "$VOICE_SCRIPT"

if [ $? -eq 0 ]; then
    log_success "Voice script modified"
else
    log_error "Modification failed"
    exit 1
fi

# Verify syntax
log_info "Validating Python syntax..."
if python3 -m py_compile "$VOICE_SCRIPT" 2>&1; then
    log_success "Python syntax valid"
else
    log_error "Syntax errors detected"
    python3 -c "import py_compile; py_compile.compile('$VOICE_SCRIPT', doraise=True)" 2>&1 | tail -20
    
    # Restore backup
    LATEST_BACKUP=$(ls -t ${VOICE_SCRIPT}.backup.* 2>/dev/null | head -1)
    cp "$LATEST_BACKUP" "$VOICE_SCRIPT"
    log_error "Restored from backup due to syntax error"
    exit 1
fi

echo ""

# Restart service
log_info "Restarting voice service..."
systemctl start evvos-pico-voice

sleep 4

if systemctl is-active --quiet evvos-pico-voice; then
    log_success "Voice service started"
else
    log_error "Voice service failed"
    journalctl -u evvos-pico-voice -n 30 --no-pager
    exit 1
fi

echo ""
log_success "✓ Voice service configured for dsnooper"
echo ""
log_info "Now run: sudo bash restore_and_configure_voice.sh"
echo "  to test shared audio with both services"
echo ""
